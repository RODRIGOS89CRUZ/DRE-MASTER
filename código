import streamlit as st
import pandas as pd
import openai
import matplotlib.pyplot as plt
from io import BytesIO

# FunÃ§Ã£o para carregar o arquivo Excel
def carregar_dre(uploaded_file):
    if uploaded_file:
        return pd.read_excel(uploaded_file)
    return None

# FunÃ§Ã£o para gerar anÃ¡lise com GPT
def gerar_analise(dre_df, openai_api_key):
    openai.api_key = openai_api_key
    prompt = f"""
    Analise o seguinte Demonstrativo de Resultados do ExercÃ­cio (DRE) e forneÃ§a insights sobre o desempenho financeiro, pontos fortes, pontos de atenÃ§Ã£o e sugestÃµes de melhoria:

    {dre_df.to_string(index=False)}
    """
    response = openai.ChatCompletion.create(
        model="gpt-4o",
        messages=[{"role": "user", "content": prompt}]
    )
    return response['choices'][0]['message']['content']

# FunÃ§Ã£o para criar dashboard
def criar_dashboard(dre_df):
    st.subheader("ğŸ“Š Dashboard Financeiro")

    if 'Receita' in dre_df.columns and 'Lucro' in dre_df.columns:
        fig, ax = plt.subplots()
        ax.plot(dre_df['PerÃ­odo'], dre_df['Receita'], marker='o', label='Receita')
        ax.plot(dre_df['PerÃ­odo'], dre_df['Lucro'], marker='o', label='Lucro')
        ax.set_xlabel('PerÃ­odo')
        ax.set_ylabel('Valores (R$)')
        ax.set_title('Receita e Lucro ao longo do tempo')
        ax.grid(True)
        ax.legend()
        st.pyplot(fig)

    if 'Custo' in dre_df.columns:
        st.subheader("Custos por PerÃ­odo")
        st.bar_chart(dre_df.set_index('PerÃ­odo')['Custo'])

    if 'Lucro' in dre_df.columns and 'Receita' in dre_df.columns:
        st.subheader("Margem de Lucro (%) por PerÃ­odo")
        dre_df['Margem (%)'] = (dre_df['Lucro'] / dre_df['Receita']) * 100
        st.line_chart(dre_df.set_index('PerÃ­odo')['Margem (%)'])

# App principal
st.set_page_config(page_title="DreMaster - InteligÃªncia Financeira", layout="wide", page_icon="ğŸ“Š")
st.title("ğŸ“ˆ DreMaster: Seu DRE, Sua InteligÃªncia Financeira")

with st.sidebar:
    st.image("https://img.icons8.com/ios-filled/100/000000/financial-growth-analysis.png", width=100)
    st.header("ğŸ”‘ ConfiguraÃ§Ãµes")
    openai_api_key = st.text_input("Insira sua OpenAI API Key (opcional para anÃ¡lise GPT)", type="password")
    uploaded_file = st.file_uploader("ğŸ“‚ Envie seu arquivo Excel do DRE", type=["xlsx"])

if uploaded_file:
    dre_df = carregar_dre(uploaded_file)

    if dre_df is not None:
        st.success("Arquivo carregado com sucesso!")
        st.dataframe(dre_df, use_container_width=True)

        if st.button("ğŸ“Š Gerar Dashboard e AnÃ¡lise"):
            with st.spinner("â³ Gerando anÃ¡lise e visualizaÃ§Ãµes..."):
                criar_dashboard(dre_df)

                if openai_api_key:
                    analise = gerar_analise(dre_df, openai_api_key)
                    st.subheader("ğŸ” AnÃ¡lise GPT")
                    st.write(analise)
                else:
                    st.info("ğŸ”¹ Chave da API nÃ£o fornecida: exibindo apenas o Dashboard.")
else:
    st.info("ğŸ”¹ Para comeÃ§ar, envie um arquivo do DRE na barra lateral.")
